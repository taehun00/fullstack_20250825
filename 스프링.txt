1. model
    SQL> desc sboard1;
    Name                                      Null?    Type
    ----------------------------------------- -------- ----------------------------
    ID                                        NOT NULL NUMBER
    APP_USER_ID                               NOT NULL NUMBER
    BTITLE                                    NOT NULL VARCHAR2(1000)
    BCONTENT                                  NOT NULL CLOB
    BPASS                                     NOT NULL VARCHAR2(255)
    BFILE                                              VARCHAR2(255)
    BHIT                                               NUMBER(10)
    BIP                                       NOT NULL VARCHAR2(255)
    CREATED_AT                                         TIMESTAMP(6)

    > dto :  bfile
    > dao :  insert, update

2. view
    from : encType = "multipart/form-data"  method="post"
            <input type = "file"/>

3. controller
    pow.xml
        <!-- commons-fileupload -->
        <dependency>
            <groupId>commons-fileupload</groupId>
            <artifactId>commons-fileupload</artifactId>
            <version>1.3.1</version>
        </dependency>

        <!-- commons-io -->
        <dependency>
            <groupId>commons-io</groupId>
            <artifactId>commons-io</artifactId>
            <version>2.11.0</version>
        </dependency>

        <!-- img upload   start -->
        <!-- img upload   start -->
        <!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload -->
        <dependency>
            <groupId>commons-fileupload</groupId>
            <artifactId>commons-fileupload</artifactId>
            <version>1.3.1</version>
        </dependency>
        <!-- img upload end -->
        <!-- img upload end -->

    servlet-context.xml
    FileUpload.java
    Controller.java





# AJAX
1.글검색
2.아이디중복검사
3.유저 수정, 삭제

1.글검색
1)model
table, dto, dao#, service
    select * from emp where ename like '$S%';

2)controller
@RestController //@Controller + @ResponseBody


3)view(AJAX)






---------------------
#8. AOP + Mybatis
---------------------
1. AOP 개요
STEP1)
- 핵심기능 : (비지니스로직)
- 부가기능 : 핵심기능(비지니스로직)을 도와줌
>> AOP - 부가기능

  @Controller    /list.do
          ■ 부가기능                    ■ 부가기능
         [시작]-  Service  (전체리스트뽑아주는 service) -[끝]
             |  처리뷰   
             ↓
         [시작]- Repository(전체리스트뽑아주는 sql   )  -[끝]


STEP2) Aspect
- 기능분리
- 런타임 시 필요한 위치에 동적으로 처리
        Advice + PointCut = Aspect
  부가기능정의   적용부위

STEP3) 용어
Target   -  대상
Advice   -  부가기능
PointCut -  적용할 타겟의 메서드를 선별하는 정규식
Weaving  -  Target에 부가기능 처리(삽입)하는 과정


STEP4) 
<<BEFORE>>         
application         
[
 [  비지니스로직    ]
 [  보안, 인증, 로직]
]

<<AFTER>>
application         
[
 **********************           
 *[   PointCut 적용부위 ]    Weaving  →    [  비지니스로직    ]
        ↑
 *[   Advice 부가기능   ] *
       ↑
 *[  보안, 인증, 로직   ] *
 *   [Aspect]
 **********************  
]
Target   -  대상
Advice   -  부가기능
PointCut -  적용할 타겟의 메서드를 선별하는 정규식
Weaving  -  Target에 부가기능 처리(삽입)하는 과정


2. AOP 특징
>> 프록시 기반 aop를 지원
- 프록시는 advice(부가기능)을 target(대상객체)에 적용하면서 생성되는 객체
- Target(대상객체)를 감싸는 프록시는 런타임 시에 생성됨.
- 타겟객체에 대한 호출을 intercept(가로채서)해서  
  A. 부가기능 수행 후 타겟의 핵심기능 로직호출(전처리)  , 
  B. 타겟의 핵심기능 로직호출  부가기능 수행  (후처리) 
  

   호출 --->   [ Proxy  [Target]  ]

3. 구현방식
1) xml
2) annotation

실습1) pom.xml
1. AspectJ runtime   -> AspectJrt
2. AspectJ weaver    -> AspectJweaver
3. Spring aop        -> spring-aop
4. api 문서
https://www.eclipse.org/aspectj/doc/next/runtime-api/

<!-- https://mvnrepository.com/artifact/org.aspectj/aspectjrt -->
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjrt</artifactId>
    <version>1.7.3</version>
    <!-- <scope>runtime</scope>  -->
</dependency>
<!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver -->
<dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.7.3</version>
    <!-- <scope>runtime</scope> -->
</dependency>
<!-- https://mvnrepository.com/artifact/org.springframework/spring-aop -->
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-aop</artifactId>
    <version>4.3.28.RELEASE</version>
</dependency>



실습2)  Advice + PointCut = Aspect
  부가기능정의   적용부위

com.thejoa703.aop
>> AopTrace.java


import org.aspectj.lang.ProceedingJoinPoint;

public class AopTrace {
   public Object trace( ProceedingJoinPoint  joinPoint)  throws Throwable{
      // 타겟메서드의 정보
      String signature = joinPoint.getSignature().toShortString();
      System.out.println(">>>> " + signature + " START! ");
      // 타겟메서드 호출시간확인
      long start = System.currentTimeMillis();
      // 타겟메서드 호출
      Object  result = joinPoint.proceed();
      long end  = System.currentTimeMillis();
      System.out.println("..... 실행시간 : " + (end - start)  + "ms");
      System.out.println(">>>> " + signature + " END! ");
      return result;
   }
}


실습3)  servlet-context.xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:aop="http://www.springframework.org/schema/aop"
   xsi:schemaLocation="http://www.springframework.org/schema/beans    http://www.springframework.org/schema/beans/spring-beans.xsd
   http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.3.xsd">
   
   <aop:config>
      <aop:aspect  id="traceAspect"   ref="aopTrace" >
         <aop:around     method="trace"  
                    pointcut="execution(public * com.company.service..*(..))"
          />
      </aop:aspect>
   </aop:config>
   
   <!-- Advice 클래스 Bean 등록 -->
   <bean  id="aopTrace"   class="com.company.aop_xml.AopTrace" />
</beans>



Aop 설정    
   1. aop:config  aop 설정정보  -  bean
   2. aspect :  advice + point cut
   3. aop:around
   aop:around
   aop:before  실행 전
   aop:after   실행 후
   aop:after-returning   정상 실행시  
   aop:after-throwing    예외 발생시  
   
   1) exection(* hello(..) )  
      hello라는 이름 메서드 / 파라미터종류는 모두
   2) exection(* hello()   )  
      hello라는 이름 메서드 / 파라미터종류는 안됨.
   3) exection(* com.company.service.UserSeviceImpl.*(..)   )  
      UserSeviceImpl 클래스의 모든메서드
   4) exection(* com.company.service.*.*(..)   )      
      service안의 모든클래스
   5) exection(* com.company.service..*(..)   )  
      .. 서브패키지의 모든클래스  

   >> https://docs.spring.io/spring-framework/docs/2.0.x/reference/aop.html


https://mybatis.org/mybatis-3/ko/dynamic-sql.html


■ MYBATIS
> 동적sql
WHY)
select * from emp;
select * from emp  where ename='Scott';
select * from emp  where job='SALESMAN';

SQL 구문)  MYBATIS 3개


Q1) select * from emp  where  ${searchType} = #{keyword}
1-1. select * from emp  where ename='Scott';
1-2. select * from emp  where job='SALESMAN';

${searchType} → ''안붙음  stmt
#{keyword}    → ''자동    pstmt

Q2) select * from emp where ename=#{ename} <if test = "job != null"> and job=#{job} </if>

select * from emp where ename='SMITH'
select * from emp where ename='SMITH' and job='CLERK'

Q3) select * from emp where

    <choose>
        <when test="ename != null"> and ename=#{ename} </when>
        <when test="job   != null"> and job=#{job}     </when>
        <otherwise> and mgr=#{mgr} </otherwise>
    </choose>

select * from emp where empno=7369 and mgr=7902
select * from emp where empno=7369 and ename='SMITH' and mgr=7902
select * from emp where empno=7369 and ename='SMITH' and job='CLERK'
select * from emp where empno=7369 and ename='SMITH' and job='CLERK' and mgr=7902

Q4) select * from emp

    <where>
        <if test="ename != null"> and ename=#{ename} </if>
        <if test="job != null"> and job=#{job} </if>
    </where>

select * from emp
select * from emp where ename='SMITH'
select * from emp where job='CLERK'
select * from emp where empno=7369 and ename='SMITH' and job='CLERK'

Q5)
<update>
    update emp
    <set>
        <if test="ename != null"> ename=#{ename}, </if>
        <if test="job != null"> job=#{job}, </if>
    </set>
    where empno=#{empno}
</update>

update emp set ename=#{ename} where empno=#{empno}
update emp set job=#{job}     where empno=#{empno}
update emp set ename=#{ename}, job=#{job}, where empno=#{empno}

Q6) forEach
select * from emp
<where>
    empno input <foreach item="no" collection="list" separator="," open="(" close=")"> #{no} </foreach>
</where>
select * from emp where empno in ( 7369, 7499, 7521 )

Q7) join
> desc authorities
이름     널?       유형            
------ -------- ------------- 
EMAIL NOT NULL VARCHAR2(100) 
AUTH   NOT NULL VARCHAR2(100) 

> desc appuser
이름           널?       유형            
------------ -------- ------------- 
APP_USER_ID  NOT NULL NUMBER(38)    
EMAIL        NOT NULL VARCHAR2(100) 
PASSWORD              VARCHAR2(100) 
MBTI_TYPE_ID          NUMBER(38)    
CREATED_AT            DATE          
UFILE                 VARCHAR2(255) 




▶ 1. Security?
- 애플리케이션의 보안(인증, 인가) 담당

▶ 2. 인증 vs 인가
- 인증 Authentication [본인]이 맞는지 확인
- 인가 Authorization  인증된 사용자가 [접근가능]

▶ 3. Security 아키텍쳐
=====================
       ② [UsernamePasswordAuthentication Token]
          ↓
① Http Request  →     [AuthenticationFilter] ③ ...  →  [Authentication  Manager]
         ↓⑩               ⑨     ←
          [SecurityContextHolder]
=====================

- 1. 사용자가 로그인 폼태그 시도 ( username + password 전달 )
- 2. UsernamePasswordAuthentication 요청정보 Authentication을 생성
- 3. Authentication 인증처리

- 10. 인증완료 [사용자정보] SecurityContextHolder 담기
    - AuthenticationSuccessHandler를 실행(성공)
    - AuthenticationFailureHandler를 실행(실패)


========================
[Authentication Manager] -> [Authentication Provider(s)]
========================

- 4. Authentication Provider(s) 인증담담.
1) UsernamePasswordAuthentication token은 Provider를 찾는데 사용
2) AuthenticationProvider      ★ 로그인정보 db정보와 비교
3) UserDetailsService          ★ db에 있는 [사용자정보] 가져오기


[실습] 설정
1. pom.xml - Security
2. Security-context.xml
3. web.xml 스프링구동
4. SecurityController
5. 테스트


## 1. pom.xml
      <!-- SECURITY -->
      <!-- SECURITY -->
      <!-- SECURITY -->
      <!-- https://mvnrepository.com/artifact/org.springframework.security/spring-security-core -->
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-web</artifactId>
         <version>4.2.2.RELEASE</version>
         <!-- <version>5.0.7.RELEASE</version> -->
      </dependency>
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-config</artifactId>
         <version>4.2.2.RELEASE</version>
      </dependency>
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-core</artifactId>
         <version>4.2.2.RELEASE</version>
      </dependency>
      <dependency>
         <groupId>org.springframework.security</groupId>
         <artifactId>spring-security-taglibs</artifactId>
         <version>4.2.2.RELEASE</version>
      </dependency>
      <!-- SECURITY -->
      <!-- SECURITY -->
      <!-- SECURITY -->

## 2. security-context.xml

<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:security="http://www.springframework.org/schema/security"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd
		http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.2.xsd">

	<bean id="bCryptPasswordEncoder" 
			class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"/>

	

	<security:http>
       <!-- 디스패처보다 먼저 실행             모든 경로            무제한허가 -->
       <security:intercept-url pattern="/security/all"    access="permitAll"/>
       <security:intercept-url pattern="/security/member" access="hasRole('ROLE_MEMBER')"/>
       <!-- 로그인폼 필요 -->
       <security:form-login/>
    </security:http>

   <security:authentication-manager>   
      <!-- provider : 실제 db상에 있는지 비교 -->
      <security:authentication-provider>
         <!-- 유저 정보 가져오기 -->
         <security:user-service>
          <security:user name="member" password="member" authorities="ROLE_MEMBER"/>
         </security:user-service>
      </security:authentication-provider>
   </security:authentication-manager>
		
</beans>


[실습] db연동
1. security-context.xml     <bean in="" class="BCrypt"/>
2. appuser-context.xml
    1) 권한 삽입
    insert into authorities (email, auth) values ('iis1@naver.com', 'ROLE_MEMBER')
    insert into authorities (email, auth) values ('iis1@naver.com', 'ROLE_ADMIN')

    2) email, password, 권한
    select  u.email, password, auth
    from appuser u left join authorities a on (u.email = a.email)
    where u.email = 'iis1@naver.com'

    3) 회원가입 insert

3. TEST


[실습] 로그인
1. security-context.xml
    로그인폼
    로그인성공
    로그인실패
    유저정보

2. 설정내용 con.thejoa703.security
3. Controller - 로그인
4. view       - login.jsp
